<!-- templates/rules.html -->
{% extends "base.html" %}
{% block content %}
<style>
  :root {
    --success: #16a34a;
    --danger: #dc2626;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-600: #4b5563;
    --gray-900: #111827;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .page-header h1 {
    font-weight: 700;
    font-size: 28px;
    color: var(--gray-900);
    margin: 0;
  }

  .view-toggle {
    display: flex;
    gap: 8px;
  }

  .view-toggle button {
    padding: 8px 16px;
    border: 1px solid var(--gray-200);
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
  }

  .view-toggle button.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  /* Блочный вид */
  .rules-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
  }

  .rule-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 24px;
    transition: all 0.2s ease;
    position: relative;
    border-left: 4px solid var(--primary);
  }

  .rule-card.disabled {
    opacity: 0.7;
    border-left-color: #9ca3af;
  }

  .rule-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }

  .rule-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
  }

  .rule-meta {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
    font-size: 14px;
    color: var(--gray-600);
    flex-wrap: wrap;
  }

  .rule-meta-item {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .rule-badge {
    padding: 2px 8px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  .badge-active { background: #dcfce7; color: var(--success); }
  .badge-inactive { background: #fee2e2; color: var(--danger); }

  .conditions-list {
    background: var(--gray-100);
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .condition-item {
    font-family: 'Fira Code', monospace;
    font-size: 14px;
    padding: 6px 0;
    display: flex;
    justify-content: space-between;
  }

  .rule-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  .btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: none;
    transition: background 0.2s;
  }

  .btn-primary { background: var(--primary); color: white; }
  .btn-outline { background: transparent; border: 1px solid var(--gray-200); color: var(--gray-600); }
  .btn-success { background: #dcfce7; color: var(--success); }
  .btn-danger { background: #fee2e2; color: var(--danger); }

  /* Списочный вид */
  .rules-list-view {
    display: none;
    flex-direction: column;
    gap: 16px;
  }

  .rule-list-item {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 16px;
    border-left: 4px solid var(--primary);
  }

  .rule-list-item.disabled {
    opacity: 0.7;
    border-left-color: #9ca3af;
  }

  .rule-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }

  .rule-list-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--gray-900);
  }

  .rule-list-meta {
    font-size: 14px;
    color: var(--gray-600);
    margin-top: 4px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .rule-list-details {
    display: none;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--gray-200);
  }

  .expand-btn {
    background: var(--primary-light);
    color: var(--primary);
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--gray-600);
  }

  .empty-state i {
    font-size: 48px;
    margin-bottom: 16px;
    color: #d1d5db;
  }

  /* Модальное окно */
  .lowcode-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    display: none;
  }

  .lowcode-content {
    background: white;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    position: relative;
  }

  .modal-close-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    background: #e53e3e;
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
  }

  .lowcode-header {
    padding: 24px;
    border-bottom: 1px solid var(--gray-200);
  }

  .lowcode-header h2 {
    font-size: 22px;
    color: var(--gray-900);
    margin: 0;
  }

  .lowcode-body {
    padding: 24px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--gray-900);
  }

  .form-control {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    font-size: 15px;
  }

  .logic-selector {
    display: flex;
    gap: 16px;
    margin-top: 8px;
  }

  .logic-option {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .conditions-editor {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .condition-row {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 12px;
    align-items: end;
  }

  .condition-row input {
    padding: 10px;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    font-size: 14px;
  }

  .condition-row button {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: var(--danger);
    color: white;
    border: none;
    cursor: pointer;
    font-weight: bold;
  }

  .add-condition {
    background: var(--primary-light);
    color: var(--primary);
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
  }

  .lowcode-footer {
    padding: 24px;
    border-top: 1px solid var(--gray-200);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }
</style>

<div class="page-header">
  <h1>Правила автоматической реакции</h1>
  <div style="display: flex; gap: 12px; align-items: center;">
    <button class="btn btn-primary" onclick="openEditor()">
      <i class="fas fa-plus"></i> Новое правило
    </button>
    <div class="view-toggle">
      <button id="view-grid" onclick="setView('grid')">
        <i class="fas fa-th-large"></i> Карточки
      </button>
      <button id="view-list" onclick="setView('list')">
        <i class="fas fa-list"></i> Список
      </button>
    </div>
  </div>
</div>

<!-- Блочный вид -->
<div class="rules-grid" id="rules-grid">
  {% for rule in rules %}
  <div class="rule-card {% if not rule.enabled %}disabled{% endif %}">
    <div class="rule-header">
      <h3 class="rule-title">{{ rule.name }}</h3>
    </div>
    <div class="rule-meta">
      <div class="rule-meta-item">
        <span>Сценарий:</span>
        <code>{{ rule.script_name }}</code>
      </div>
      <div class="rule-meta-item">
        <span>Логика:</span>
        <span>{{ "Все условия (И)" if rule.logic == 'AND' else "Любое условие (ИЛИ)" }}</span>
      </div>
      <div class="rule-meta-item">
        <span class="rule-badge {{ 'badge-active' if rule.enabled else 'badge-inactive' }}">
          {{ "Активно" if rule.enabled else "Неактивно" }}
        </span>
      </div>
    </div>
    {% if rule.conditions %}
    <div class="conditions-list">
      {% for cond in rule.conditions %}
        <div class="condition-item">
          <span>{{ cond.field_key }}</span>
          <span>= "{{ cond.value }}"</span>
        </div>
      {% endfor %}
    </div>
    {% endif %}
    <div class="rule-actions">
      <button class="btn btn-outline" onclick="editRule({{ rule.id }})">
        <i class="fas fa-edit"></i> Редактировать
      </button>
      <form method="POST" action="{{ url_for('delete_rule', rule_id=rule.id) }}" style="display: inline;" onsubmit="return confirm('Удалить правило?')">
        <button type="submit" class="btn btn-danger">
          <i class="fas fa-trash"></i> Удалить
        </button>
      </form>
      <form method="POST" action="{{ url_for('toggle_rule', rule_id=rule.id) }}" style="display: inline;">
        <button type="submit" class="btn {% if rule.enabled %}btn-danger{% else %}btn-success{% endif %}">
          <i class="fas fa-{% if rule.enabled %}power-off{% else %}toggle-on{% endif %}"></i>
          {{ "Выключить" if rule.enabled else "Включить" }}
        </button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Списочный вид -->
<div class="rules-list-view" id="rules-list-view">
  {% for rule in rules %}
  <div class="rule-list-item {% if not rule.enabled %}disabled{% endif %}" data-rule-id="{{ rule.id }}">
    <div class="rule-list-header" onclick="toggleRuleDetails(this)">
      <div>
        <div class="rule-list-title">{{ rule.name }}</div>
        <div class="rule-list-meta">
          <span>Сценарий: <code>{{ rule.script_name }}</code></span>
          <span>Логика: {{ "И" if rule.logic == 'AND' else "ИЛИ" }}</span>
          <span class="rule-badge {{ 'badge-active' if rule.enabled else 'badge-inactive' }}">
            {{ "Активно" if rule.enabled else "Неактивно" }}
          </span>
        </div>
      </div>
      <button class="expand-btn">+</button>
    </div>
    <div class="rule-list-details">
      {% if rule.conditions %}
        <div style="margin-bottom: 16px;">
          <strong>Условия:</strong>
          <div style="background: var(--gray-100); padding: 12px; border-radius: 8px; margin-top: 8px;">
            {% for cond in rule.conditions %}
              <div style="font-family: monospace; font-size: 14px;">{{ cond.field_key }} = "{{ cond.value }}"</div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
      <div class="rule-actions" style="justify-content: flex-start; gap: 12px;">
        <button class="btn btn-outline" onclick="editRule({{ rule.id }})">
          <i class="fas fa-edit"></i> Редактировать
        </button>
        <form method="POST" action="{{ url_for('delete_rule', rule_id=rule.id) }}" style="display: inline;" onsubmit="return confirm('Удалить правило?')">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash"></i> Удалить
          </button>
        </form>
        <form method="POST" action="{{ url_for('toggle_rule', rule_id=rule.id) }}" style="display: inline;">
          <button type="submit" class="btn {% if rule.enabled %}btn-danger{% else %}btn-success{% endif %}">
            <i class="fas fa-{% if rule.enabled %}power-off{% else %}toggle-on{% endif %}"></i>
            {{ "Выключить" if rule.enabled else "Включить" }}
          </button>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% if not rules %}
<div class="empty-state">
  <i class="fas fa-robot"></i>
  <h3 style="font-size: 20px; margin: 0 0 12px;">Нет правил реакции</h3>
  <p>Создайте первое правило для автоматического реагирования на инциденты.</p>
</div>
{% endif %}

<!-- Low-code редактор (модальное окно) -->
<div class="lowcode-modal" id="lowcode-editor">
  <div class="lowcode-content">
    <button class="modal-close-btn" onclick="closeEditor()">
      <i class="fas fa-times"></i>
    </button>
    <div class="lowcode-header">
      <h2 id="editor-title">Новое правило</h2>
    </div>
    <div class="lowcode-body">
      <form id="rule-form">
        <div class="form-group">
          <label for="rule-name">Название правила</label>
          <input type="text" id="rule-name" name="name" class="form-control" placeholder="Блокировка IP-адреса" required>
        </div>
        <div class="form-group">
          <label for="rule-script">Сценарий реакции</label>
          <select id="rule-script" name="script_name" class="form-control" required>
            <option value="">— Выберите сценарий —</option>
            {% for s in scripts %}
            <option value="{{ s }}">{{ s }}.sls</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Логика и статус</label>
          <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end;">
            <div>
              <div class="logic-selector">
                <label class="logic-option">
                  <input type="radio" name="logic" value="AND" checked> Все условия (И)
                </label>
                <label class="logic-option">
                  <input type="radio" name="logic" value="OR"> Любое условие (ИЛИ)
                </label>
              </div>
            </div>
            <div>
              <label>
                <input type="checkbox" name="enabled" checked>
                Правило активно
              </label>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>Условия срабатывания</label>
          <div class="conditions-editor" id="conditions-editor">
            <!-- Динамические строки -->
          </div>
          <button type="button" class="add-condition" onclick="addCondition()">
            <i class="fas fa-plus"></i> Добавить условие
          </button>
        </div>
        <input type="hidden" id="rule-id-field" name="rule_id">
      </form>
    </div>
    <div class="lowcode-footer">
      <button class="btn btn-outline" onclick="closeEditor()">Отмена</button>
      <button class="btn btn-primary" onclick="saveRule()">Сохранить правило</button>
    </div>
  </div>
</div>

<script>
  // === Переключение вида ===
  function setView(view) {
    localStorage.setItem('rulesView', view);
    document.getElementById('rules-grid').style.display = view === 'grid' ? 'grid' : 'none';
    document.getElementById('rules-list-view').style.display = view === 'list' ? 'flex' : 'none';
    document.getElementById('view-grid').classList.toggle('active', view === 'grid');
    document.getElementById('view-list').classList.toggle('active', view === 'list');
  }

  document.addEventListener('DOMContentLoaded', () => {
    const savedView = localStorage.getItem('rulesView') || 'grid';
    setView(savedView);
  });

  // === Раскрытие в списке ===
  function toggleRuleDetails(header) {
    const details = header.nextElementSibling;
    const btn = header.querySelector('.expand-btn');
    if (details.style.display === 'block') {
      details.style.display = 'none';
      btn.textContent = '+';
    } else {
      details.style.display = 'block';
      btn.textContent = '−';
    }
  }

  // === Модальное окно ===
  function openEditor() {
    document.getElementById('lowcode-editor').style.display = 'flex';
    document.getElementById('editor-title').textContent = 'Новое правило';
    resetForm();
  }

  function closeEditor() {
    document.getElementById('lowcode-editor').style.display = 'none';
  }

  function resetForm() {
    document.getElementById('rule-form').reset();
    document.getElementById('conditions-editor').innerHTML = '';
  }

  function addCondition(field = '', value = '') {
    const container = document.getElementById('conditions-editor');
    const index = container.children.length;
    const div = document.createElement('div');
    div.className = 'condition-row';
    div.innerHTML = `
      <input type="text" name="cond_field_${index}" value="${field}" placeholder="Поле (src_ip)" required>
      <input type="text" name="cond_value_${index}" value="${value}" placeholder="Значение" required>
      <button type="button" onclick="this.closest('.condition-row').remove()">×</button>
    `;
    container.appendChild(div);
  }

  function editRule(ruleId) {
    openEditor();
    fetch(`/api/rule/${ruleId}`)
      .then(r => r.json())
      .then(rule => {
        document.getElementById('rule-name').value = rule.name;
        document.getElementById('rule-script').value = rule.script_name;
        document.querySelector(`input[name="logic"][value="${rule.logic}"]`).checked = true;
        document.querySelector('input[name="enabled"]').checked = rule.enabled;
        const container = document.getElementById('conditions-editor');
        container.innerHTML = '';
        rule.conditions.forEach(cond => addCondition(cond.field_key, cond.value));
        document.getElementById('editor-title').textContent = 'Редактирование правила';
        document.getElementById('rule-id-field').value = rule.id;
      })
      .catch(err => {
        alert('Ошибка загрузки правила');
        closeEditor();
      });
  }

  function saveRule() {
    const form = document.getElementById('rule-form');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    const formData = new FormData(form);
    let url = '/rule/edit';
    const ruleId = formData.get('rule_id');
    if (ruleId) {
      url += '/' + ruleId;
    }

    fetch(url, {
      method: 'POST',
      body: formData
    })
    .then(() => {
      closeEditor();
      location.reload();
    })
    .catch(err => {
      alert('Ошибка сохранения');
      console.error(err);
    });
  }

  // Закрытие по Esc и клику вне
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeEditor();
  });
  document.getElementById('lowcode-editor').addEventListener('click', (e) => {
    if (e.target === document.getElementById('lowcode-editor')) {
      closeEditor();
    }
  });
</script>

{% endblock %}