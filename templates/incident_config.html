<!-- templates/incident_config.html -->
{% extends "base.html" %}
{% block content %}
<h2>Конфигурация полей инцидентов</h2>

<form method="post" id="config-form">
  <!-- === ОБЯЗАТЕЛЬНЫЕ ПОЛЯ: ИСТОЧНИК === -->
  <div style="background: #f0f7ff; padding: 16px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid #2a5298;">
    <h3 style="margin-top: 0; color: #2a5298;">Источник инцидента (обязательно)</h3>
    <p style="margin-bottom: 12px; font-size: 14px; color: #555;">
      Укажите <strong>хотя бы одно</strong> из полей: IP-адрес источника или его hostname.
      Система будет использовать их для привязки инцидента к миньону.
    </p>

    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end; margin-bottom: 12px;">
      <div>
        <label style="font-size: 13px; color: #4a5568;">IP-адрес источника</label>
        <input type="text" name="src_ip_path" value="{{ src_ip_path or '' }}"
               placeholder="event_src.ip" style="width: 100%; padding: 8px; margin-top: 4px;">
      </div>
      <div>
        <label style="font-size: 13px; color: #4a5568;">Hostname источника</label>
        <input type="text" name="src_hostname_path" value="{{ src_hostname_path or '' }}"
               placeholder="agent.hostname" style="width: 100%; padding: 8px; margin-top: 4px;">
      </div>
      <div style="align-self: end; padding-top: 22px;">
        <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
          Обязательно
        </span>
      </div>
    </div>
  </div>

  <!-- === ДРУГИЕ ПОЛЯ === -->
  <h3>Дополнительные поля (опционально)</h3>
  <div id="fields-container" style="display: grid; gap: 16px; max-width: 650px; margin-bottom: 20px;">
    {% if custom_fields %}
      {% for field in custom_fields %}
      <div class="field-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: end;">
        <input type="text" name="display_name_{{ loop.index0 }}" value="{{ field.display_name }}" placeholder="Отображаемое имя" style="padding: 8px;" required>
        <input type="text" name="field_key_{{ loop.index0 }}" value="{{ field.field_key }}" placeholder="Ключ (латиница)" style="padding: 8px;" required>
        <input type="text" name="json_path_{{ loop.index0 }}" value="{{ field.json_path }}" placeholder="JSON-путь (a.b.c)" style="padding: 8px;" required>
        <button type="button" onclick="this.closest('.field-row').remove()" style="padding: 8px; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">×</button>
      </div>
      {% endfor %}
    {% endif %}
  </div>

  <button type="button" onclick="addRow()" style="margin: 10px 0 16px; padding: 8px 16px; background: #3182ce; color: white; border: none; border-radius: 4px;">+ Добавить поле</button>
  <button type="submit" style="padding: 10px 20px; background: #2a5298; color: white; border: none; border-radius: 4px;">Сохранить</button>
</form>

<script>
function addRow() {
  const container = document.getElementById('fields-container');
  const index = container.children.length;
  const div = document.createElement('div');
  div.className = 'field-row';
  div.style.display = 'grid';
  div.style.gridTemplateColumns = '1fr 1fr 1fr auto';
  div.style.gap = '8px';
  div.style.alignItems = 'end';
  div.innerHTML = `
    <input type="text" name="display_name_${index}" placeholder="Отображаемое имя" style="padding: 8px;" required>
    <input type="text" name="field_key_${index}" placeholder="Ключ (латиница)" style="padding: 8px;" required>
    <input type="text" name="json_path_${index}" placeholder="JSON-путь (a.b.c)" style="padding: 8px;" required>
    <button type="button" onclick="this.closest('.field-row').remove()" style="padding: 8px; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">×</button>
  `;
  container.appendChild(div);
}
</script>

<a href="{{ url_for('incidents') }}" style="display: inline-block; margin-top: 20px; color: #2a5298;">← Назад к инцидентам</a>
{% endblock %}